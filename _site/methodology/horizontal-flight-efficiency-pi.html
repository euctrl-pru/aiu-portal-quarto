<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.543">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>AIU Portal - Performance Indicator - Horizontal Flight Efficiency</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../favicon.png" rel="icon" type="image/png">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="https://eurocontrol.int" class="navbar-brand navbar-brand-logo">
    <img src="../images/EUROCONTROL-logo-standard-rgb.png" alt="EUROCONTROL website" class="navbar-logo">
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">AIU Home</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-about" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">About</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-about">    
        <li>
    <a class="dropdown-item" href="../about/prc/index.html">
 <span class="dropdown-text">About PRC</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../about/pru/index.html">
 <span class="dropdown-text">About PRU</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="../data/index.html"> 
<span class="menu-text">Data</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-reference" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Reference</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-reference">    
        <li>
    <a class="dropdown-item" href="../acronym/index.html">
 <span class="dropdown-text">Acronyms</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../methodology/index.html">
 <span class="dropdown-text">Methodology</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../bibliography/index.html">
 <span class="dropdown-text">Bibliography</span></a>
  </li>  
    </ul>
  </li>
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Performance Indicator - Horizontal Flight Efficiency</h1>
<p class="subtitle lead">Level 1 and 2 documentation of the Horizontal Flight Efficiency key performance indicators</p>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="introduction" class="level1">
<h1>Introduction</h1>
<section id="general" class="level2">
<h2 class="anchored" data-anchor-id="general">General</h2>
<p>This document describes the conceptual, informational, and implementation independent model of the Horizontal Flight Efficiency Indicators – KEP, KEA and KES.</p>
<p>The indicator is used as part of the performance monitoring and reporting under:</p>
<ul>
<li>SES: IR317/2019 <span class="citation" data-cites="eu:317/2019">(<a href="#ref-eu:317/2019" role="doc-biblioref">EU 2019</a>)</span> repealing Implementing Regulations (EU) No IR390/2013 <span class="citation" data-cites="eu:390/2013">(<a href="#ref-eu:390/2013" role="doc-biblioref">EU 2013a</a>)</span> and (EU) No 391/2013 <span class="citation" data-cites="eu:391/2013">(<a href="#ref-eu:391/2013" role="doc-biblioref">EU 2013b</a>)</span>; and</li>
<li>EUROCONTROL: performance review reporting.</li>
</ul>
</section>
<section id="purpose-of-the-document" class="level2">
<h2 class="anchored" data-anchor-id="purpose-of-the-document">Purpose of the document</h2>
<p>The purpose of this document is to provide a description of the horizontal flight efficiency indicator and its two versions used in the Performance Scheme Regulation – KEP and KEA. It addresses different audiences with different needs, and for that reason the description is provided at increasing level of detail.</p>
<p>Section <a href="#summary-of-the-performance-indicator-information">Summary of the performance indicator information</a> provides a high level description of the indicator, introduces the concept of achieved distance and provides the rationale for its use as the base for the computation of the additional distance (i.e., the balance of the need to evaluate local performance with the need to take into consideration its impact on the measurement of network performance). It includes a final subsection with some special cases and frequently asked questions which should help clarify how it is calculated.</p>
</section>
<section id="scope" class="level2">
<h2 class="anchored" data-anchor-id="scope">Scope</h2>
<p>This document covers the data processing and calculation of the Horizontal Flight Efficiency key performance indicators (KEP, KEA, KES).</p>
<p>The calculation of this performance indicator is performed according to the Horizontal Flight Efficiency Data Flow standard for data collection and processing, under the responsibility of the operations unit in the QoS department of the PRU, which is compliant with IR317/2019. The Horizontal Flight Efficiency Data Flow associated processes and procedures are documented as part of the PRU Quality Management System.</p>
<p>These key performance indicators are also defined in the Implementing Regulation (317/2019), Annex I:</p>
<ul>
<li>Section 1, Environment 2.1, (KEA, Union-wide level);</li>
<li>Section 1, Environment 2.2, (KEP, KES Union-wide level);</li>
<li>Section 2, Environment 2.1, (KEA, National, Functional Airspace Block level);</li>
<li>Section 2, Environment 2.2, (KEP, KES National, Functional Airspace Block level);</li>
</ul>
</section>
<section id="summary-of-the-performance-indicator-information" class="level2">
<h2 class="anchored" data-anchor-id="summary-of-the-performance-indicator-information">Summary of the performance indicator information</h2>
<ul>
<li><p>Current version status: Target Setting.</p></li>
<li><p>Version status and evolution:</p>
<ul>
<li>Conceptual Phase: phase completed.</li>
<li>Technical Development: phase completed.</li>
<li>Prototyping / Validation: phase completed.</li>
<li>Monitoring: RP1, RP2, RP3, active.</li>
<li>Target Setting: RP1, RP2, RP3, active.</li>
<li>Phase Out: n/a.</li>
</ul></li>
<li><p>Context</p>
<ul>
<li>KPA: Environment.</li>
<li>Focus Area: Horizontal Flight Efficiency.</li>
<li>Trade Offs: local and network performance.</li>
<li>Supports the SES Performance Scheme.</li>
</ul></li>
<li><p>Description: The indicators provide a measure of the average en route additional distance with respect to the great circle distance.</p></li>
<li><p>Formula and Metrics</p>
<p>The indicator considers all portions of flights traversing an airspace and compares the flown and the achieved distance:</p>
<p><span class="math display">\[
  \textrm{HFE}_j = \frac{\sum L_{fjp} - \sum H_{fjp}}{\sum H_{fjp}} \% = \Big( \frac{\sum L_{fjp}}{\sum H_{fjp}} - 1  \Big) \%
  \]</span></p>
<p>Where <span class="math inline">\(L\)</span> is the length of the trajectory and <span class="math inline">\(H\)</span> is the achieved distance; <span class="math inline">\(f\)</span> is the flight, <span class="math inline">\(j\)</span> is the airspace and <span class="math inline">\(p\)</span> is the portion considered.</p></li>
<li><p>Units Percentage (additional distance per achieved distance).</p></li>
<li><p>Used in</p>
<ul>
<li>SES IR317/2019: Annual Performance Report.</li>
<li>SES eDashboard [ RP1 <span class="citation" data-cites="prb:dashboardRP1">(<a href="#ref-prb:dashboardRP1" role="doc-biblioref">Performance Review Body 2015</a>)</span>, RP2 <span class="citation" data-cites="prb:dashboardRP2">(<a href="#ref-prb:dashboardRP2" role="doc-biblioref">Performance Review Body 2016</a>)</span> and RP3 <span class="citation" data-cites="prb:dashboardRP3">(<a href="#ref-prb:dashboardRP3" role="doc-biblioref">Performance Review Body 2020</a>)</span>]</li>
<li>EUROCONTROL: Performance Review Report</li>
</ul></li>
</ul>
</section>
<section id="acronyms-and-terminology" class="level2">
<h2 class="anchored" data-anchor-id="acronyms-and-terminology">Acronyms and terminology</h2>
<table class="table">
<caption>(#tab:acronyms) Acronyms and terminology</caption>
<colgroup>
<col style="width: 36%">
<col style="width: 63%">
</colgroup>
<thead>
<tr class="header">
<th>Term</th>
<th>Definition</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>ANSP</td>
<td>Air Navigation Service Provider</td>
</tr>
<tr class="even">
<td>ATFM</td>
<td>Air Traffic Flow Management</td>
</tr>
<tr class="odd">
<td>ATM</td>
<td>Air Traffic Management</td>
</tr>
<tr class="even">
<td>CPF</td>
<td>Profile based on correlated positions report</td>
</tr>
<tr class="odd">
<td>CPR</td>
<td>Correlated Position Report</td>
</tr>
<tr class="even">
<td>DB</td>
<td>Database</td>
</tr>
<tr class="odd">
<td>EU</td>
<td>European Union</td>
</tr>
<tr class="even">
<td>FAB</td>
<td>Functional Airspace Block</td>
</tr>
<tr class="odd">
<td>FAQ</td>
<td>Frequently Asked Questions</td>
</tr>
<tr class="even">
<td>FIR</td>
<td>Flight Information Region</td>
</tr>
<tr class="odd">
<td>FTFM</td>
<td>Last filed flight plan</td>
</tr>
<tr class="even">
<td>GCD</td>
<td>Great Circle Distance</td>
</tr>
<tr class="odd">
<td>HFE</td>
<td>Horizontal Flight Efficiency</td>
</tr>
<tr class="even">
<td>ICAO</td>
<td>International Civil Aviation Organization</td>
</tr>
<tr class="odd">
<td>ID</td>
<td>Identifier</td>
</tr>
<tr class="even">
<td>IR317</td>
<td>COMMISSION REGULATION (EU) No 317/2019</td>
</tr>
<tr class="odd">
<td>KEA</td>
<td>Key performance Environment indicator based on Actual trajectory</td>
</tr>
<tr class="even">
<td>KEP</td>
<td>Key performance Environment indicator based on last filed flight Plan</td>
</tr>
<tr class="odd">
<td>KES</td>
<td>Key performance Environment indicator based on shortest constrained route available for flight planning</td>
</tr>
<tr class="even">
<td>KPA</td>
<td>Key Performance Area</td>
</tr>
<tr class="odd">
<td>KPI</td>
<td>Key Performance Indicator</td>
</tr>
<tr class="even">
<td>LOBT</td>
<td>Last received Off-Block Time</td>
</tr>
<tr class="odd">
<td>NM</td>
<td>Network Manager</td>
</tr>
<tr class="even">
<td>PRR</td>
<td>Performance Review Report</td>
</tr>
<tr class="odd">
<td>PRU</td>
<td>Performance Review Unit</td>
</tr>
<tr class="even">
<td>QoS</td>
<td>Quality of Service</td>
</tr>
<tr class="odd">
<td>RP1</td>
<td><span class="math inline">\(1^{st}\)</span> Reference Period (2012-2014)</td>
</tr>
<tr class="even">
<td>RP2</td>
<td><span class="math inline">\(2^{nd}\)</span> Reference Period (2015-2019)</td>
</tr>
<tr class="odd">
<td>RP3</td>
<td><span class="math inline">\(3^{rd}\)</span> Reference Period (2020-2024)</td>
</tr>
<tr class="even">
<td>SES</td>
<td>Single European Sky</td>
</tr>
<tr class="odd">
<td>TMA</td>
<td>Terminal Manoeuvring Area</td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="conceptual-model-the-horizontal-flight-efficiency" class="level1">
<h1>Conceptual model The Horizontal Flight Efficiency</h1>
<p>Horizontal flight efficiency (HFE) is very simply defined at its highest level: the comparison between the length of a trajectory and the shortest distance between its endpoints.</p>
<p>(ref:hfe-01) HFE as comparison of flight length and Great Circle Distance.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">include_graphics</span>(<span class="st">"hfe-01.png"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="hfe-01.png" class="img-fluid figure-img" width="400"></p>
<figcaption>(ref:hfe-01)</figcaption>
</figure>
</div>
</div>
</div>
<p>For an entire flight we want to calculate the additional distance flown between take-off and landing with respect to the most direct route between the two airports (Great Circle Distance). The need of a more detailed definition arises because we need to take into consideration different variations from the situation described above, such as the possibility that one (if not both) of the airports does not belong to the area on which we would like to measure the efficiency and the need to define the measurement on a portion of the flight (e.g., en route) instead than for the whole trajectory.</p>
<p>In addition, there is a specific need which stems from the SES requirements <strong>to measure local performance (FAB level) while at the same time keeping the network perspective.</strong></p>
<p>(ref:hfe-02) Local Performance Requirement.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">include_graphics</span>(<span class="st">"hfe-02.png"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="hfe-02.png" class="img-fluid figure-img" width="700"></p>
<figcaption>(ref:hfe-02)</figcaption>
</figure>
</div>
</div>
</div>
<p>The desired outcome is illustrated in the table above. We are interested in all flights which traverse at least in part the Single European Sky (SES) area. A flight might traverse several FABs but also areas which are not part of the SES area. This means that, for the purpose of measuring flight efficiency in the SES area, we are interested only in the values in the green cells of the table. At the same time we would like to be able to consider the additional distances along the flight dimension (i.e., along a row, giving a flight value in the light blue cell in the last column) and along the FAB dimension (i.e., along a column, giving a FAB value in the light blue cell in the last row) and obtain consistent values. The sum of the all values in the green cells, the sum of all values in the last column (i.e.&nbsp;sum of flight values) and the sum of all values in the last row (i.e., sum of the FAB values) should all be the same (i.e., using flight values and using FAB values should lead to the same sum when considering all flights in the SES area).</p>
<p>This is true when the values in the table correspond to the flown distance and the achieved distance (defined in the following section), which allows to apportion the great circle distance for the entire trajectory to any of its parts, e.g., between the entry and exit into a FAB.</p>
<section id="the-achieved-distance" class="level2">
<h2 class="anchored" data-anchor-id="the-achieved-distance">The achieved distance</h2>
<p>The achieved distance is the average of two quantities. The first quantity considers how closer to destination the trajectory takes from its entry point into an area to its exit point from the area (left part of Figure @ref(fig:hfe-03)). This can be calculated as the difference between</p>
<ol type="1">
<li>the great circle distance from the entry point N to the destination D and</li>
<li>the great circle distance from the exit point X to the destination D.</li>
</ol>
<p>(ref:hfe-03) The two Quantities Averaged in the Achieved Distance.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">include_graphics</span>(<span class="st">"hfe-03.png"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="hfe-03.png" class="img-fluid figure-img" width="550"></p>
<figcaption>(ref:hfe-03)</figcaption>
</figure>
</div>
</div>
</div>
<p>In the Figure @ref(fig:hfe-03), the distance from <span class="math inline">\(N\)</span> to <span class="math inline">\(D\)</span> is the radius of the circle centred at <span class="math inline">\(D\)</span> and going through the point of entry <span class="math inline">\(N\)</span>, while the distance from <span class="math inline">\(X\)</span> to <span class="math inline">\(D\)</span> is the radius of the circle centred at <span class="math inline">\(D\)</span> and going through the point <span class="math inline">\(X\)</span>.</p>
<p>In a similar way the second quantity considers how further from origin the trajectory takes from its entry point into an area to its exit point from the area (right part of the picture). The roles of the entry point <span class="math inline">\(N\)</span> and the exit point <span class="math inline">\(X\)</span> are reversed and the quantity is calculated as the difference between</p>
<ol type="1">
<li>the great circle distance from the origin <span class="math inline">\(O\)</span> and the exit point <span class="math inline">\(X\)</span>, and</li>
<li>the great circle distance from the origin <span class="math inline">\(O\)</span> and the entry point <span class="math inline">\(N\)</span>.</li>
</ol>
<p>Considering two specific points along the trajectory (for example its entry point <span class="math inline">\(N\)</span> and its exit point <span class="math inline">\(X\)</span> into/from an area), together with the origin <span class="math inline">\(O\)</span> and the destination <span class="math inline">\(D\)</span>, the formula to compute the achieved distance is:</p>
<p><span class="math display">\[
\frac{1}{2} ( \text{ND} - \text{XD} + \text{OX} - \text{ON} )
\]</span></p>
<p>where all the distances between points are calculated as great circle distances.</p>
<p>It can be verified that taking a sequence of points between <span class="math inline">\(O\)</span> and <span class="math inline">\(D\)</span>, e.g., a sequence of entry/exit points in different areas, the sum of the achieved distances (including the one from the origin to the first point and the one from the last point to the destination) is equal to the great circle distance between the origin and the destination.</p>
</section>
<section id="achieved-distances-and-network-contribution" class="level2">
<h2 class="anchored" data-anchor-id="achieved-distances-and-network-contribution">Achieved distances and network contribution</h2>
<p>It might seem natural to consider the comparison of the flown distance in a local area with the great circle distance between the entry and exit point of the same area. Such a measurement would not take into consideration the network perspective, as can be seen in the (extreme, for illustration purposes) example of the Figure @ref(fig:hfe-04).</p>
<p>(ref:hfe-04) A case of perfect local efficiency with no network contribution.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">include_graphics</span>(<span class="st">"hfe-04.png"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="hfe-04.png" class="img-fluid figure-img" width="480"></p>
<figcaption>(ref:hfe-04)</figcaption>
</figure>
</div>
</div>
</div>
<p>The red trajectory between the entry point N and the exit point X is perfectly straight and would be considered perfectly efficient from the local point of view, while from the network perspective there has been no improvement as the aircraft would be no closer to destination (and no further from the origin).</p>
<p>The great circle distance taken as reference is the one between the origin and destination of the flight. The sum of the great circle distances in the different areas traversed is always larger than the great circle distance between origin and destination. Given that the sum of the flown distance would be the same, using local great circle distances for the comparison would always underestimate the inefficiency at flight level. The achieved distances, on the other hand, do sum up to the great circle distance between origin and destination.</p>
</section>
<section id="decomposition-of-inefficiency-in-local-and-interface-components" class="level2">
<h2 class="anchored" data-anchor-id="decomposition-of-inefficiency-in-local-and-interface-components">Decomposition of inefficiency in local and interface components</h2>
<p>The value of the achieved distance between two points is by construction less than the direct distance between the same two points. This enables a decomposition of the inefficiency into a local component (which we call extension) and a network contribution (which we call interface) as shown in the Figure @ref(fig:hfe-05).</p>
<p>(ref:hfe-05) Decomposition of Inefficiency.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">include_graphics</span>(<span class="st">"hfe-05.png"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="hfe-05.png" class="img-fluid figure-img" width="600"></p>
<figcaption>(ref:hfe-05)</figcaption>
</figure>
</div>
</div>
</div>
<p>In the example of the previous section, the extension is zero (the red line corresponds to the direct between entry and exit) and the inefficiency is equal to the interface value. The exact interface value would depend on the position of the entry and exit points with respect to the origin and destination of the trajectory. If both <span class="math inline">\(N\)</span> and <span class="math inline">\(X\)</span> were equidistant from the origin and destination (i.e., <span class="math inline">\(\overline{OX} = \overline{XD}\)</span> and <span class="math inline">\(\overline{ON} = \overline{ND}\)</span>) the achieved distance would be zero and the interface value would be equal to the direct distance between entry and exit. From the network point of view, since there is “no improvement” in the goal of getting from origin to destination, any distance flown between the two points should be considered as additional distance.</p>
</section>
<section id="independence-of-local-performance-from-performance-outside-the-local-area" class="level2">
<h2 class="anchored" data-anchor-id="independence-of-local-performance-from-performance-outside-the-local-area">Independence of local performance from performance outside the local area</h2>
<p>(ref:hfe-06) Independence of local performance from performance outside the local area.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">include_graphics</span>(<span class="st">"hfe-06.png"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="hfe-06.png" class="img-fluid figure-img" width="700"></p>
<figcaption>(ref:hfe-06)</figcaption>
</figure>
</div>
</div>
</div>
<p>The value of the achieved distance to be considered for a local area depends only on the position of the entry and exit points with respect to the origin and destination of the trajectory. As a consequence, the value of the local inefficiency is independent from the characteristics of the rest of the trajectory.</p>
<p>Consider the situation in Figure @ref(fig:hfe-06) (once again an extreme example to illustrate the point), with two flights traversing a FAB, one with a direct trajectory from the origin to destination (thus both inside and outside the FAB), and the other with a direct (and aligned) trajectory inside the FAB but with an inefficient trajectory outside the FAB.</p>
<p>With the achieved distance, the value used for the FAB measurement will be the same for both flights because inside the FAB the trajectory is identical (in this specific case both the extension and the interface will be zero, as the trajectory is direct between entry and exit and the entry and exit points are aligned with the origin and destination).</p>
<p>It has been proposed to compute the value of the local efficiency as the average, taken over all flights traversing the local area, of the entire trajectories. In the example above, while the two trajectories are identical within the FAB, their contribution would be different because the inefficiency of trajectory <span class="math inline">\(1\)</span> outside the FAB will be taken into account (as a matter of fact, the calculation would not isolate the local performance). As a result, the inefficiency of the FAB will also be greater than zero.</p>
</section>
<section id="summary-of-the-different-quantities" class="level2">
<h2 class="anchored" data-anchor-id="summary-of-the-different-quantities">Summary of the different quantities</h2>
<p>Table @ref(tab:quantities) below provides a summary of the different quantities involved in the computation of the additional distance (and therefore the inefficiency) for a flight. As can be seen in the last column, while the lengths of the trajectory, the achieved distances and the additional distances are additive, the same is not true for the lengths of direct course, the extensions and the interfaces. In particular, it should be noted that it is the sum of the achieved distances which corresponds to the great circle distance for the flight, not the sum of the length of direct courses.</p>
<table class="table">
<caption>(#tab:quantities) Summary of the different quantities used to compute HFE</caption>
<colgroup>
<col style="width: 8%">
<col style="width: 12%">
<col style="width: 24%">
<col style="width: 41%">
<col style="width: 13%">
</colgroup>
<thead>
<tr class="header">
<th>Name</th>
<th>Network</th>
<th>Local (area <span class="math inline">\(J\)</span>)</th>
<th>Consistency local and network</th>
<th>Additive</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Length of trajectory</td>
<td><span class="math inline">\(L\)</span></td>
<td><span class="math inline">\(L_j\)</span></td>
<td><span class="math inline">\(\sum_{j} L_j = L\)</span></td>
<td>Yes</td>
</tr>
<tr class="even">
<td>Length of direct course</td>
<td><span class="math inline">\(G\)</span></td>
<td><span class="math inline">\(G_j\)</span></td>
<td><span class="math inline">\(\sum_{j} G_j \ne G\)</span></td>
<td>No</td>
</tr>
<tr class="odd">
<td>Achieved distance</td>
<td><span class="math inline">\(H (= G)\)</span></td>
<td><span class="math inline">\(H_j\)</span></td>
<td><span class="math inline">\(\sum_{j} H_j = G (= H)\)</span></td>
<td>Yes</td>
</tr>
<tr class="even">
<td>Extension</td>
<td><span class="math inline">\(E = L -G\)</span></td>
<td><span class="math inline">\(E_j\)</span></td>
<td><span class="math inline">\(\sum_{j} E_j \ne L - G (= E)\)</span></td>
<td>No</td>
</tr>
<tr class="odd">
<td>Interface</td>
<td><span class="math inline">\(I = G - H\)</span></td>
<td><span class="math inline">\(I_j\)</span></td>
<td><span class="math inline">\(\sum_{j} I_j \ne 0 (= I)\)</span></td>
<td>No</td>
</tr>
<tr class="even">
<td>Additional distance</td>
<td><span class="math inline">\(K = L -H (= L - G)\)</span></td>
<td><span class="math inline">\(K_j = L_j - H_j\)</span></td>
<td><span class="math inline">\(\sum_{j} K_j = K\)</span></td>
<td>Yes</td>
</tr>
</tbody>
</table>
</section>
<section id="aggregation-of-results-to-produce-the-indicator" class="level2">
<h2 class="anchored" data-anchor-id="aggregation-of-results-to-produce-the-indicator">Aggregation of results to produce the indicator</h2>
<p>Once the origin and destination of a flight have been set, via the use of achieved distances it is possible to compute in a consistent way the value of the indicator between any two points of the trajectory of a flight. It is important to note that the flight efficiency is an average measurement where <strong>the average is taken over distances and not over flights</strong>. This is particularly useful when dealing with three specific aspects:</p>
<ul>
<li>The measurement of the en-route flight inefficiency. The indicator is concerned with the enroute flight inefficiency defined as the measurement which excludes 40 nautical miles around airports. The measurement does not start until the trajectory has crossed (for the first time) the cylinder with a 40 nautical miles radius around the airport of departure and ends when the trajectory crosses (for the last time) the cylinder with a 40 nautical miles radius around the airport of arrival.</li>
<li>The measurement of local inefficiencies. The indicator based on achieved distances is well defined even when the direct route between origin and destination does not cross the local area. It is also well defined when a trajectory exits and re-enters a local area (the two measurements are independent).</li>
<li>The measurement of inefficiency when the trajectory is not complete (which might be the case for CPF trajectories). The measurement is well defined for every portion of the trajectory, and does not require a complete trajectory.</li>
</ul>
<p>When looking at a specific flight, it is always possible to decompose the flight in different portions, of which some will not be taken into consideration for the calculation of the indicator (as an example, the first part of the trajectory will never be included because it will either be inside the 40 nautical miles or outside of the reference area). Every portion can be attributed to a specific measured area (e.g., a State, a FAB, the SES area).</p>
<p>Flight efficiency compares the length of a trajectory with the great circle distance. The indicator is expressed as a ratio of the length of trajectories and achieved distances:</p>
<p><span class="math display">\[
\text{HFE}_j = \frac{\sum L_{fjp} - \sum H_{fjp}}{\sum H{fjp}} \% = \left( \frac{\sum L_{fjp}}{\sum H_{fjp}} - 1 \right) \%
\]</span></p>
<p>In words, the en route horizontal flight efficiency indicator for an area j is taken by summing the values over all flights f and all en route portions p in the area (a flight might re-enter the area).</p>
<p>At a technical level, it is worth noting again that the indicator is an average per distance unit and not per flight.</p>
</section>
<section id="difference-between-kep-kea-kes" class="level2">
<h2 class="anchored" data-anchor-id="difference-between-kep-kea-kes">Difference between KEP, KEA, KES</h2>
<p>There is no difference in the methodology used to calculate the value of the two indicators. The KEP indicator is the horizontal flight efficiency calculated using the last filed flight plans to describe the trajectories, while KEA uses the trajectories generated via radar data. KES is based on the shortest constrained route available for flight planning.</p>
<p>In order to smooth out the influence of unusual events, in reporting annual values the ten best days and the ten worst days (for each measured area) will be excluded from the computation.</p>
</section>
<section id="specificspecial-cases-and-faq" class="level2">
<h2 class="anchored" data-anchor-id="specificspecial-cases-and-faq">Specific/special cases and FAQ</h2>
<p>The origin and destination points are defined via the reference area chosen, while the definition of the end route portion of the flight depends on the 40 nautical miles cylinder (cylinder and circle are used interchangeably) around the airports. In the general case in which the airports and the corresponding circles are fully inside or outside the reference area the following table @ref(tab:locations) is valid (the definition of the type of flight is based on the location of the airports with respect to the reference area):</p>
<table class="table">
<caption>(#tab:locations) General location of origin, destination and en-route end-points</caption>
<colgroup>
<col style="width: 22%">
<col style="width: 12%">
<col style="width: 24%">
<col style="width: 21%">
<col style="width: 18%">
</colgroup>
<thead>
<tr class="header">
<th>Type of flight</th>
<th>Origin</th>
<th>En-route Starts</th>
<th>En-route Ends</th>
<th>Destination</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Internal</td>
<td>Airport</td>
<td>40 NM</td>
<td>40 NM</td>
<td>Airport</td>
</tr>
<tr class="even">
<td>Arriving</td>
<td>Border</td>
<td>Border</td>
<td>40 NM</td>
<td>Airport</td>
</tr>
<tr class="odd">
<td>Departing</td>
<td>Airport</td>
<td>40 NM</td>
<td>Border</td>
<td>Border</td>
</tr>
<tr class="even">
<td>Overflying</td>
<td>Border</td>
<td>Border</td>
<td>Border</td>
<td></td>
</tr>
</tbody>
</table>
<ol type="1">
<li><p><strong>What is the difference between reference area and measured area?</strong></p>
<p>The reference area is the one used to identify the origin and the destination of a flight. A measured area is an area for which HFE values are reported. Any measured area (e.g., State, FAB, SES area) must be contained in the reference area.</p></li>
<li><p><strong>What is the definition of origin and destination?</strong></p>
<p>The origin and destination correspond to the first and last point of the trajectory within the reference area, where the trajectory considered is the entire trajectory from airport to airport. Any portion of the trajectory before the origin and after the destination is ignored when calculating the flight efficiency. There is one origin and one destination for each trajectory. Origin and destination are defined at trajectory level – O and D in the notation used in previous section are the same for all entries and exits of a trajectory.</p></li>
<li><p><strong>What happens when the trajectory crosses the 40 nautical miles cylinder several times?</strong></p>
<p>Only one point is taken into consideration for each airport. For the departure airport it corresponds to the first crossing, while for the arrival airport it corresponds to the last crossing. The en route part of the flight is the one between those two points. Any portion before or after the en route part is ignored when calculating the en route flight efficiency. The start and the end en route phase are defined at trajectory level.</p></li>
<li><p><strong>What happens when the circle around the airport is not fully inside/outside the reference area?</strong><br> <strong>What happens when the en route portion begins/ends inside a measured area?</strong><br> <strong>What happens when part of the trajectory is not available?</strong></p>
<p>All the above questions relate to the definition of the portions of trajectory used for the calculation of the en route indicator for a measured area. Four separate and independent aspects have to be considered:</p>
<ul>
<li>A portion has to be within the origin and the destination (for flight efficiency to be defined);</li>
<li>A portion has to be en route (i.e., the cylinders around airports have to excluded);</li>
<li>A portion has to be within the measured area;</li>
<li>The information has to be available.</li>
</ul>
<p>The four conditions have to be valid at the same time. This means that in some cases the end points of the portion considered for flight efficiency in a measured area (the entry N and the exit X in the notation used in previous sections) will not correspond to the borders of the measured area.</p>
<p>The main reason for the entry/exit points not being on the border of the measured area is the exclusion of the circles around the airport (see table above and the following examples). A secondary reason is the absence of information for a part of a trajectory (see example below).</p>
<p>Consider the case of a flight departing from a measured area A, with the circle/cylinder entirely contained in the measurement area A. The origin (<span class="math inline">\(O_f\)</span>) will be the airport because it will be the first point into the reference area (a measured area is always part of the reference area). As the part within the cylinder has to be excluded when measuring the en route flight efficiency, the entry into the measured area (<span class="math inline">\(N_A\)</span>) will correspond to the first crossing of the (departure airport) cylinder. It is neither the airport (airports can never be the entry or exit point for en route flight efficiency because of the exclusion of the circle around them) nor the border of the measured area A. The situation corresponds to the standard “departing” or “internal” row in the table above.</p>
<p>Consider the same case above, except that the circle extends into another measured area B and the first crossing is happening there. The origin will still be located at the airport in measured area A, but there will be no portion of trajectory considered for measured area A because the en route part will not have started. The entry into measured area B (NB) will again correspond to the first crossing of the (departure airport) cylinder and not the airport or the border of measured area B.</p>
<p>As a third alternative, consider the case where the circle around area A extends outside the reference area, the first crossing happens there and the flight then re-enter measured area A. The origin will again be located at the airport; the en route portion will start outside the reference area; the first entry into area A (NA) will be the one from outside the reference area.</p>
<p>Last, consider the case where a flight traverses a measured area, with entry and exit on the borders but with a part of the trajectory for which the information is missing. In that case there will be two portions of the trajectory considered: the first one from the border (<span class="math inline">\(N_1\)</span>) until the information is lost (<span class="math inline">\(X_1\)</span>) and a second one from when the information is again available (<span class="math inline">\(N_2\)</span>) until the exit from the measured area (<span class="math inline">\(X_2\)</span>).</p></li>
<li><p><strong>What happens when the trajectory enters an area several times?</strong> Every couple of entry and exit points (see the previous answer for why the entry and exit points might not correspond to points on the border of the measured area considered) defines a portion of the flight for which the length of the trajectory and the achieved distance can be calculated. All portions within a measured area are considered in the calculation of the indicator for that area.</p>
<p>It is important to note that multiple entries are considered separately and it is not the first point of entry and the last point of exit of a measured area which are considered (see last example in the previous question).</p></li>
<li><p><strong>Can the achieved distance be negative?</strong> The achieved distance relies on the order of the points considered; it is therefore possible (although uncommon) for the local achieved distance to be negative. This ensures that the calculation of the local additional distances is consistent (any partition of the trajectory gives the same result).</p></li>
<li><p><strong>What is the impact of short flights (for which the great circle distance is small)?</strong> The horizontal flight efficiency (HFE) is not an average per flight, but a weighted average which takes into consideration the great circle distance (<span class="math inline">\(K\)</span> is the additional distance, <span class="math inline">\(G\)</span> is the great circle distance, <span class="math inline">\(H\)</span> is the achieved distance; <span class="math inline">\(f\)</span> indicates a flight, <span class="math inline">\(j\)</span> indicates an area, <span class="math inline">\(p\)</span> indicates a portion of the flight):</p>
<p><span class="math display">\[
\text{HFE} = \sum w_f \cdot \frac{K_f}{G_f} = \sum \frac{G_f}{\sum G_f} \cdot \frac{K_f}{G_f}
= \frac{\sum K_f}{\sum G_f} = \frac{K_f}{H_f} \cong \frac{\sum K_{fjp}}{\sum
H_{fjp}}
\]</span></p>
<p>The contribution to the additional distance of each portion of the flight is proportional to the achieved distance of the same portion. The impact of short flights is therefore proportional to their lengths.</p></li>
<li><p><strong>What is the impact of unusual circumstances on the annual indicator?</strong></p>
<p>When calculating the annual indicator the values for the ten best days and the ten worst days are excluded from the computation.</p></li>
</ol>
</section>
</section>
<section id="references" class="level1">




</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-eu:390/2013" class="csl-entry" role="listitem">
EU. 2013a. <span>“Commission <span>Implementing Regulation</span> (<span>EU</span>) <span>No</span> 390/2013 of 3 <span>May</span> 2013 Laying down a Performance Scheme for Air Navigation Services and Network Functions <span>Text</span> with <span>EEA</span> Relevance.”</span>
</div>
<div id="ref-eu:391/2013" class="csl-entry" role="listitem">
EU. 2013b. <span>“Commission <span>Implementing Regulation</span> (<span>EU</span>) <span>No</span> 391/2013 of 3 <span>May</span> 2013 Laying down a Common Charging Scheme for Air Navigation Services <span>Text</span> with <span>EEA</span> Relevance.”</span>
</div>
<div id="ref-eu:317/2019" class="csl-entry" role="listitem">
EU. 2019. <span>“Commission <span>Implementing Regulation</span> (<span>EU</span>) 2019/317 of 11 <span>February</span> 2019 Laying down a Performance and Charging Scheme in the Single <span>European</span> Sky and Repealing <span>Implementing Regulations</span> (<span>EU</span>) <span>No</span> 390/2013 and (<span>EU</span>) <span>No</span> 391/2013 (<span>Text</span> with <span>EEA</span> Relevance.).”</span>
</div>
<div id="ref-prb:dashboardRP1" class="csl-entry" role="listitem">
Performance Review Body. 2015. <span>“Dashboard <span>RP1</span>.”</span> <a href="http://www.eurocontrol.int/prudata/dashboard/eur_view_2014.html">http://www.eurocontrol.int/prudata/dashboard/eur_view_2014.html</a>.
</div>
<div id="ref-prb:dashboardRP2" class="csl-entry" role="listitem">
———. 2016. <span>“Dashboard <span>RP2</span>.”</span> <a href="http://www.eurocontrol.int/prudata/dashboard/rp2_2015.html">http://www.eurocontrol.int/prudata/dashboard/rp2_2015.html</a>.
</div>
<div id="ref-prb:dashboardRP3" class="csl-entry" role="listitem">
———. 2020. <span>“Dashboard <span>RP3</span>.”</span> <a href="https://www.eurocontrol.int/prudata/dashboard/vis/">https://www.eurocontrol.int/prudata/dashboard/vis/</a>.
</div>
</div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>